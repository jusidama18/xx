#!/usr/bin/env python3
# https://github.com/Sorrow446/ZS-DL
# plugin by @aryanvikash

from telegram.ext import CommandHandler, run_async
import re

import requests

from bot import userge, Message, pool
from bot.helper.ext_utils.bot_utils import get_readable_message

@run_async
    def zippyshare(update,context):
    """ zippy to direct """
    message = get_readable_message()
    url = message.input_str
    await message.edit("`Generating url ....`")
    try:
        direct_url, fname = await _generate_zippylink(url)
        await message.edit(f"**Original** : {url}\n**FileName** : `{fname}`\n"
                           f"**DirectLink** : {direct_url}\n\n"
                           "**[HINT]** : use `.download [directLink]`",
                           disable_web_page_preview=True)
    except Exception as z_e:  # pylint: disable=broad-except
        await message.edit(f"`{z_e}`")


_REGEX_LINK = r'https://www(\d{1,3}).zippyshare.com/v/(\w{8})/file.html'
_REGEX_RESULT = (
    r'document.getElementById\(\'dlbutton\'\).href = "/d/[a-zA-Z\d]{8}/" '
    r'\+ \((\d+) % (\d+) \+ (\d+) % (\d+)\) \+ "\/(.+)";'
)
_HEADERS = {'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                          "AppleWebKit/537.36 (KHTML, like Gecko) Chrome"
                          "/75.0.3770.100 Safari/537.36"}


@run_async
def _generate_zippylink(url):
    session = requests.Session()
    session.headers.update(_HEADERS)
    with session as ses:
        match = re.match(_REGEX_LINK, url)
        if not match:
            raise ValueError("Invalid URL: " + str(url))
        server, id_ = match.group(1), match.group(2)
        res = ses.get(url)
        res.raise_for_status()
        match = re.search(_REGEX_RESULT, res.text)
        if not match:
            raise ValueError("Invalid Response!")
        val_1 = int(match.group(1))
        val_2 = int(match.group(2))
        val_3 = int(match.group(3))
        val_4 = int(match.group(4))
        val = val_1 % val_2 + val_3 % val_4
        name = match.group(5)
        d_l = "https://www{}.zippyshare.com/d/{}/{}/{}".format(server, id_, val, name)
    return d_l, name
